/* 
  Stepper Motor : Joystick - Speed/Direction
  Goal : Use a joystick to control the speed and direction of a stepper motor.
  Main Theme : Using analog input to control a stepper motor without delay().
*/

#include <Stepper.h>   // Include the Stepper library

// Number of steps per revolution for the 28BYJ-48 stepper motor
const int STEPS_PER_REV = 32;
const int GEAR_RATIO = 64;

// Total output shaft steps after internal gearing
const int TOTAL_STEPS = STEPS_PER_REV * GEAR_RATIO;

// Initialize the stepper motor with pin sequence IN1-IN3-IN2-IN4
// (depends on your ULN2003 driver board printing)
Stepper motor(STEPS_PER_REV, 8, 10, 9, 11);

// Joystick pins
const int joyX = A1;   // X-axis controls direction
const int joyY = A0;   // Y-axis controls speed

// Timing variables for non-blocking stepping
unsigned long previousMillis = 0;
const int stepInterval = 10;  // Time between step pulses (ms)

void setup() {
  Serial.begin(9600);        // Start serial communication
}

void loop() {

  unsigned long currentMillis = millis();  // Store current time

  // Read joystick axes (0–1023)
  int xVal = analogRead(joyX);             // Direction input
  int yVal = analogRead(joyY);             // Speed input

  // --- Determine Stepper Direction ---
  int direction = 0;                       // 0 = stop, -1 = CCW, 1 = CW
  if (xVal < 450) direction = -1;          // If joystick pushed left → CCW
  else if (xVal > 550) direction = 1;      // If joystick pushed right → CW
  else direction = 0;                      // Joystick centered → STOP

  // --- Map Speed ---
  // Joystick pushed forward (low value) → fast speed
  // Joystick backward (high value) → slow speed
  int speed = map(yVal, 0, 1023, 600, 0);  // 0 = max speed, 600 = slow

  // --- Non-blocking step control ---
  if (currentMillis - previousMillis >= stepInterval) {
    previousMillis = currentMillis;        // Update the timer

    if (direction != 0) {                  // Only move if joystick is off-center
      motor.setSpeed(speed);               // Set motor speed (RPM)
      motor.step(direction);               // Step one position in selected direction
    }
  }

  // --- Debug Output ---
  Serial.print("X: "); Serial.print(xVal);
  Serial.print(" | Y: "); Serial.print(yVal);
  Serial.print(" | Speed: "); Serial.print(speed);
  Serial.print(" | Direction: ");
  if (direction == 1) Serial.println("CW");
  else if (direction == -1) Serial.println("CCW");
  else Serial.println("STOP");
}
